{% import "macros/urls.html" as urls %}

{% macro print_artists(artists, print_by) %}
    {% if print_by %}
        {% if artists|length > 1 %}
            with
        {% else %}
            by
        {% endif %}
    {% endif %}
    {% for artist in artists %}
        {%- if artists|length > 1 and loop.last %}
        and
        {% elif not loop.first -%}
        ,
        {% endif %}
        <a href="{{ urls.artist_url(artist) }}">{{ artist.name|show_ws }}</a>
    {%- endfor %}.
{% endmacro %}

{% macro print_articles_nav(remotes, index, active = True) %}
    {% if remotes %}
        {% if remotes.wikipedia|count > 0 %}
            {% for wikipedia in remotes.wikipedia %}
                {% set title = wikipedia.title ~ (" | " ~ wikipedia.language if wikipedia.language != 'en') %}
                <li data-toggle="pill" class="{{ "active" if active and loop.first }}">
                    <a rel="tooltip" title="{{ title }}" href="#wikipediatab_{{ index }}_{{ loop.index }}">
                        {{ title }}
                    </a>
                </li>
            {% endfor %}
            {% if remotes.lastfm and remotes.lastfm.bio %}
                <li data-toggle="pill" class="{{ "active" if active and remotes.wikipedia|count == 0 }}">
                    <a href="#lastfmtab_{{ index }}">Last.fm Artist</a>
                </li>
            {% endif %}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro print_articles_content(remotes, index, active = True) %}
    {% if remotes %}
        {% if remotes.wikipedia|count > 0 %}
            {% for wikipedia in remotes.wikipedia %}
                <div class="pill-pane {{ "active" if active and loop.first }}" id="wikipediatab_{{ index }}_{{ loop.index }}">
                    <p class="wikipedia-content">{{ wikipedia.summary }}</p>
                    <p class="wikipedia-footer">
                        ... continue reading at
                        <a href="{{ wikipedia.url }}">
                            {{ wikipedia.title }}
                            {% if wikipedia.language != 'en' %}
                                | {{ wikipedia.language }}
                            {% endif %}
                        </a>.
                    </p>
                    {% if wikipedia.language != "en" %}
                        <p class="wikipedia-footer wikipedia-footer-sub">
                            ... and try your luck on
                            <a href='http://translate.google.com/translate?u={{ wikipedia.url|urlencode }}'>
                                Google Translate
                            </a>
                        </p>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
        {% if remotes.lastfm and remotes.lastfm.bio %}
            <div class="pill-pane {{ "active" if active and remotes.wikipedia|count == 0 }}" id="lastfmtab_{{ index }}">
                <div class="lastfm_bio">
                    {{ remotes.lastfm.bio|nl2p }}
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro print_articles(remotes_artist, remotes_album = None, remotes_track = None) %}
    {% set album_active = False if remotes_track and (remotes_track.wikipedia|count > 0 or
        remotes_track.lastfm and remotes_track.lastfm.bio) else True %}

    {% set artist_active = album_active and (False if remotes_album and (remotes_album.wikipedia|count > 0 or
        remotes_album.lastfm and remotes_album.lastfm.bio) else True) %}

    <div class="pill-content">
        {{ print_articles_content(remotes_track, 0) }}
        {{ print_articles_content(remotes_album, 1, album_active) }}
        {{ print_articles_content(remotes_artist, 2, artist_active) }}
    </div>
    <ul class="nav nav-pills nav-pills-sm">
        {{ print_articles_nav(remotes_track, 0) }}
        {{ print_articles_nav(remotes_album, 1, album_active) }}
        {{ print_articles_nav(remotes_artist, 2, artist_active) }}
    </ul>
{% endmacro %}

{% import "macros/covers.html" as covers %}

{% if same_artists|length > 0 %}
    <p class="alert alert-info">
        {% for artist in same_artists %}
            <a href="{{ urls.artist_url(artist) }}">{{ artist.name|show_ws }}</a>
            {%- if same_artists|length > 2 and loop.index == same_artists|length - 1 %}
            and
            {%- elif not loop.last -%}
            ,
            {% endif %}
        {% endfor %}
        looks like
        {% if same_artists|length == 1 %}
            it
        {% else %}
            they 
        {% endif %}
        might be the same artist as this one? If so, please correct
        {% if same_artists|length == 1 %}
            its
        {% else %}
            their
        {% endif %}
        tags.
    </p>
{% endif %}

<div class="artist-head">
    <div class="row">
        <div class="col-xs-7">
            {% if track %}
                <h3 class="track-head">
                    <a href="/library/track/{{ track.slug|urlencode }}">{{ track.name|show_ws }}</a>
                    {% if album %}
                        <small>
                            on <a href="{{ urls.album_url(album) }}">{{ album.name|show_ws }}</a>
                        </small>
                    {% endif %}
                </h3>
                {% if artists and artists|length > 0 %}
                    <p class="track-subline">
                        {{ print_artists(artists, true) }}
                    </p>
                {% endif %}
            {% elif album %}
                <h3 class="album-head">
                    <a href="{{ urls.album_url(album) }}">{{ album.name|show_ws }}</a>
                    {% if album.date %}
                        <span class="date">{{ album.date }}</span>
                    {% endif %}
                    {% if artists and artists|length > 0 %}
                        <small>
                            {{ print_artists(artists, true) }}
                        </small>
                    {% endif %}
                </h3>
                <p class="album-subline">
                    {{ album.tracks|length }} tracks, {{ album.duration|format_seconds }} long, added {{ album.added|pretty_date }}.
                </p>
            {% else %}
            <h3>
                {{ print_artists(artists, false) }}
            </h3>
            {% endif %}
            {% if artist %}
                <div class="remotes remotes_artist_head_{{ artist.id }}">
                    {% if remotes_artist %}
                        {{ print_articles(remotes_artist) }}
                    {% endif %}
                </div>
            {% elif album %}
                <div class="remotes remotes_album_head_{{ album.id }}">
                    {% if remotes_album %}
                        {{ print_articles(remotes_artists[0] if remotes_artists|count > 0, remotes_album) }}
                    {% endif %}
                </div>
            {% elif track %}
                <div class="remotes remotes_track_head_{{ track.id }}">
                    {% if remotes_track %}
                        {{ print_articles(remotes_artist, remotes_album, remotes_track) }}
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <div class="col-xs-5">
        {% if album %}
            <div class="album cover">
        {% elif artists %}
            <div class="artist cover">
        {% endif %}
                <figure class="effeckt-caption" data-effeckt-type="half-slide">
                    {% if album %}
                        {{ covers.album(album) }}
                    {% elif artists %}
                        {{ covers.artist(artists[0]) }}
                    {% endif %}
                    <figcaption>
                        <div class="effeckt-figcaption-wrap">
                            <div class="left">
                            </div>
                            <div class="right">
                                {% if is_granted('admin') %}
                                    {% if album %}
                                        <a class="remove-cover btn btn-default btn-sm"
                                            href="/cover_refresh/album/{{ album.slug|urlencode }}">
                                            <i class="icon-refresh"></i>
                                        </a>
                                    {% elif artists %}
                                        <a class="remove-cover btn btn-default btn-sm"
                                            href="/cover_refresh/artist/{{ artists[0].slug|urlencode }}">
                                            <i class="icon-refresh"></i>
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </figcaption>
                </figure>
            </div>
        </div>
    </div>
</div>
